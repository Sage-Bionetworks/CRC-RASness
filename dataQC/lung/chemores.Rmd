CHEMORES DESCRIPTION NEEDED HERE. These samples were QCed initially using the `affyPLM` package. The following plot shows the Relative Log Expression (RLE) and Normalized Unscaled Standard Errors (NUSE) plots for all samples.

```{r loadData, include=FALSE}
#outputFilePath = file.path(tempdir(), "chemoresQcedExpressionSet.rbin")
#used = c("syn1680071", "syn1681152", "syn1680091", "syn1681333")

## SCRIPT TO QC AND PROCESS THE CHEMORES DATASET
#####
## ANALYST: BRIAN M. BOT
#####

require(synapseClient)
require(rGithubClient)
require(affy)
require(affyPLM)
require(limma)
require(chron)
require(corpcor)
require(ggplot2)

## SOURCE IN UTILITY FUNCTIONS
myRepo <- getRepo(repository="Sage-Bionetworks/CRC-RASness",
                  ref="branch", refName="dev")
sourceRepoFile(myRepo, "functions/utilityFunctions.R")

## GRAB THE TARGETS FOR THE EXPRESSION DATA
crTargetsEnt <- downloadEntity("syn1680091")
crTargets <- readTargets(file.path(crTargetsEnt$cacheDir, crTargetsEnt$files))

## READ IN EXPRESSION OBJECT -- RGList OBJECT
chemoresExprEnt <- loadEntity("syn1680948")
chemoresExpr <- chemoresExprEnt$objects$RG
chemoresExpr <- backgroundCorrect(chemoresExpr, method="normexp", offset=70)
chemoresExpr <- normalizeWithinArrays(chemoresExpr, method="loess", iterations=3)
chemoresExpr <- avereps(chemoresExpr, ID=chemoresExpr$genes$ProbeName)

## GET RID OF THE DYE BIAS USING THE DYE SWAP INFORMATION: (T/N-N/T)/2
tmpExpr <- matrix(as.numeric(NA), nrow=nrow(chemoresExpr$M), ncol=ncol(chemoresExpr$M)/2)
colnames(tmpExpr) <- unique(chemoresExpr$targets$PatientID)
rownames(tmpExpr) <- rownames(chemoresExpr$M)
for( pt in unique(chemoresExpr$targets$PatientID) ){
  these <- chemoresExpr$target[ chemoresExpr$target$PatientID==pt, ]
  these$file <- sub(".txt", "", these$FileName, fixed=T)
  tmpExpr[, pt] <- as.numeric(chemoresExpr$M[, these$file[these$Polarity=="+"] ]) - (chemoresExpr$M[, these$file[these$Polarity=="-"] ])
}

## BRING IN THE CUSTOM ARRAY DESIGN
annotEnt <- downloadEntity("syn1681333")
annot <- read.delim(file.path(annotEnt$cacheDir, annotEnt$files), header=T, as.is=T)
rownames(annot) <- annot$ProbeID

## GET RID OF CONTROL PROBES
tmpExpr <- tmpExpr[ chemoresExpr$genes$ControlType==0, ]
chemoresExpr <- tmpExpr[rownames(annot), ]
chemoresExpr <- combineProbesToGene(chemoresExpr, annot$GeneName)


## READ IN THE CLINICAL DATA
clinEnt <- downloadEntity("syn1681152")
chemoresClin <- read.delim(file.path(clinEnt$cacheDir, clinEnt$files), header=T, as.is=T)
rownames(chemoresClin) <- chemoresClin$Patient_ID_sssyymmdd
chemoresClin <- chemoresClin[colnames(chemoresExpr), ]

## SVD ON EXPRESSION MATRIX -- ASSESS OVERALL STRUCTURE AND POSSIBLE LATENT STRUCTURE
s <- fs(chemoresExpr)
```

```{r rawSvd, echo=FALSE}
qplot(1:length(s$d), s$d,
      xlab="eigen gene",
      ylab="% variance explained")
qplot(s$v[, 1], s$v[, 2],
      xlab="1st svd",
      ylab="2nd svd")
```

The first SVD appears to explain about 20% of the variation and did not appear strongly associated with any clinical covariates.

```{r normalize, include=FALSE}
fit <- lmFit(chemoresExpr, model.matrix(~as.numeric(chemoresClin$age) + factor(chemoresClin$MF)))

chemoresExprAdj <- chemoresExpr - fitted.values(fit)

## MAKE SURE NO LARGE AMOUNTS OF VARIATION HAVE BEEN ADDED BY PROCESS
sAdj <- fs(chemoresExprAdj)
```

The gene-specific fitted values of age were removed from the expression matrix (gender information not available). The following plots are SVD plots after age effects were removed to ensure this did not introduce any unwanted effects to the data.

```{r svdAdj, echo=FALSE}
qplot(1:length(sAdj$d), sAdj$d,
      xlab="eigen gene",
      ylab="% variance explained")
qplot(sAdj$v[, 1], sAdj$v[, 2],
      xlab="1st svd",
      ylab="2nd svd")
```

```{r saveObject, include=FALSE}
## FINALIZE THE SAMPLES THAT WILL BE KEPT FOR FURTHER ANALYSIS
## REMOVE UNANNOTATED KRAS
exprSetAdj <- new("ExpressionSet")
expr(exprSetAdj) <- chemoresExprAdj
pData(exprSetAdj) <- chemoresClin

chemoresQcedExpressionSet <- exprSetAdj
save("chemoresQcedExpressionSet", file=file.path(tempdir(), "chemoresQcedExpressionSet.rbin"))
```

